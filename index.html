<!DOCTYPE html>
<html>
<head>
    <title>Microbe Evolution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; background: #1a1a1a; }
        #gameCanvas { position: absolute; }
        .ui {
            position: fixed; padding: 10px; background: #00000055; 
            border-radius: 5px; color: white; font-family: Arial;
        }
        #stats { top: 10px; left: 10px; display: none; }
        #menu { 
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); text-align: center; 
        }
        button {
            background: #444; color: white; border: none;
            padding: 15px 30px; margin: 10px; border-radius: 20px;
            font-size: 18px; touch-action: manipulation;
        }
        #joystick {
            position: fixed; bottom: 100px; left: 50px;
            width: 100px; height: 100px; 
            background: #ffffff33; border-radius: 50%;
            display: none;
        }
        #joystickHandle {
            position: absolute; width: 40px; height: 40px;
            background: #ffffff66; border-radius: 50%;
            top: 30px; left: 30px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="menu">
        <h1>Microbe Evolution</h1>
        <button id="startButton">Start Game</button>
        <div id="gameOver" style="display: none;">
            <h2>Game Over!</h2>
            <button id="restartButton">Play Again</button>
        </div>
    </div>

    <div id="stats" class="ui">
        <div>Health: <span id="health">100</span></div>
        <div>Energy: <span id="energy">50</span></div>
        <div>DNA: <span id="dna">0</span></div>
    </div>

    <div id="joystick">
        <div id="joystickHandle"></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const WORLD_SIZE = 2000;
let cameraX = 0, cameraY = 0;
let gameRunning = false;
let joystickActive = false;
let joystickVector = { x: 0, y: 0 };

// Настройки управления
const JOYSTICK_RADIUS = 50;
const JOYSTICK_DEADZONE = 20;

// Инициализация игры
function initGame() {
    // Сброс состояния игрока
    Object.assign(player, {
        x: WORLD_SIZE/2, y: WORLD_SIZE/2, 
        health: 100, energy: 50, dna: 0
    });

    // Генерация мира
    world.resources = [];
    world.creatures = [];
    world.particles = [];
    generateWorld();

    // Показать элементы игры
    document.getElementById('stats').style.display = 'block';
    document.getElementById('joystick').style.display = 'block';
    document.getElementById('menu').style.display = 'none';
    gameRunning = true;
    
    // Запуск игрового цикла
    update();
}

// Игровой цикл
function update() {
    if(!gameRunning) return;

    // Обновление игрока
    const speed = player.speed * (player.energy > 0 ? 1 : 0.5);
    if(joystickVector.x !== 0 || joystickVector.y !== 0) {
        player.x += joystickVector.x * speed;
        player.y += joystickVector.y * speed;
        player.direction = Math.atan2(joystickVector.y, joystickVector.x);
        player.energy = Math.max(0, player.energy - 0.1);
    }

    // Проверка здоровья
    if(player.health <= 0) {
        gameRunning = false;
        document.getElementById('gameOver').style.display = 'block';
        document.getElementById('stats').style.display = 'none';
        document.getElementById('joystick').style.display = 'none';
        return;
    }

    // Остальная логика игры...
    // (код обновления мира, существ и т.д. из предыдущей версии)

    requestAnimationFrame(update);
    draw();
}

// Отрисовка
function draw() {
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Отрисовка существ
    world.creatures.concat([player]).forEach(creature => {
        const screenX = creature.x - cameraX;
        const screenY = creature.y - cameraY;
        
        // Тело
        ctx.fillStyle = creature.color || '#ffffff';
        ctx.beginPath();
        ctx.arc(screenX, screenY, creature.size, 0, Math.PI*2);
        ctx.fill();

        // Белые глаза
        const eyeDist = creature.size * 0.4;
        const eyeAngle = creature.direction;
        [Math.PI/6, -Math.PI/6].forEach(offset => {
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(
                screenX + Math.cos(eyeAngle + offset) * eyeDist,
                screenY + Math.sin(eyeAngle + offset) * eyeDist,
                creature.size * 0.2, 0, Math.PI*2
            );
            ctx.fill();
        });
    });

    // Отрисовка джойстика
    const joystick = document.getElementById('joystickHandle');
    joystick.style.transform = `translate(
        ${joystickVector.x * 30}px, 
        ${joystickVector.y * 30}px
    )`;
}

// Джойстик
let touchId = null;
const joystickBase = document.getElementById('joystick');

joystickBase.addEventListener('touchstart', e => {
    e.preventDefault();
    const rect = joystickBase.getBoundingClientRect();
    touchId = e.changedTouches[0].identifier;
    updateJoystick(e.changedTouches[0], rect);
});

joystickBase.addEventListener('touchmove', e => {
    e.preventDefault();
    const touch = Array.from(e.touches).find(t => t.identifier === touchId);
    if(touch) {
        const rect = joystickBase.getBoundingClientRect();
        updateJoystick(touch, rect);
    }
});

joystickBase.addEventListener('touchend', e => {
    e.preventDefault();
    joystickVector = { x: 0, y: 0 };
    touchId = null;
});

function updateJoystick(touch, rect) {
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    const dx = touch.clientX - centerX;
    const dy = touch.clientY - centerY;
    const distance = Math.sqrt(dx*dx + dy*dy);
    const angle = Math.atan2(dy, dx);

    if(distance > JOYSTICK_RADIUS) {
        joystickVector.x = Math.cos(angle);
        joystickVector.y = Math.sin(angle);
    } else {
        joystickVector.x = dx / JOYSTICK_RADIUS;
        joystickVector.y = dy / JOYSTICK_RADIUS;
    }

    if(Math.abs(joystickVector.x) < JOYSTICK_DEADZONE/JOYSTICK_RADIUS) joystickVector.x = 0;
    if(Math.abs(joystickVector.y) < JOYSTICK_DEADZONE/JOYSTICK_RADIUS) joystickVector.y = 0;
}

// Обработчики кнопок
document.getElementById('startButton').addEventListener('click', initGame);
document.getElementById('restartButton').addEventListener('click', initGame);

// Инициализация
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
window.Telegram.WebApp.ready();
</script>
</body>
</html>