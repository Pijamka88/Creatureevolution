<!DOCTYPE html>
<html>
<head>
    <title>Microbe Evolution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* ... (стили остаются такими же) ... */
    </style>
</head>
<body>
    <!-- ... (HTML остаётся таким же) ... -->

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const WORLD_SIZE = 1500;
const BORDER_SIZE = 50;
let cameraX = 0, cameraY = 0;
let gameActive = false;
let joystickVector = { x: 0, y: 0 };

// ... (остальной код до создания существ) ...

const EVOLUTION_STAGES = [
    { size: 15, speed: 1.2, vision: 200 }, // Stage 1
    { size: 20, speed: 1.5, vision: 250 }, // Stage 2
    { size: 25, speed: 1.8, vision: 300 }, // Stage 3
    { size: 30, speed: 2.0, vision: 350 }  // Stage 4
];

function createCreature(type, x, y) {
    const base = {
        x, y, 
        size: 15, speed: 1.2, vision: 200,
        health: 100, direction: 0,
        attack: 0, lastAttack: 0, cooldown: false,
        glow: 0, consumedFood: 0,
        evolutionStage: 0, evolutionProgress: 0,
        animationPhase: 0, // Для анимации движения
        animationSpeed: 0.1
    };
    
    switch(type) {
        case 'predator':
            return {...base, 
                color: '#ff4444', 
                speed: 1.5,
                attack: 5,
                attackCooldown: 2000
            };
        case 'herbivore':
            return {...base,
                color: '#44ff44',
                flee: true,
                herd: null
            };
        case 'parasite':
            return {...base,
                color: '#aa44ff',
                size: 10,
                drain: 2
            };
    }
}

function updateCreatures(deltaTime) {
    world.creatures.forEach(creature => {
        // Анимация движения
        creature.animationPhase += creature.animationSpeed;
        if(creature.animationPhase >= Math.PI*2) {
            creature.animationPhase -= Math.PI*2;
        }

        // Эволюция
        if(creature.consumedFood >= 10 && creature.evolutionStage < EVOLUTION_STAGES.length - 1) {
            creature.evolutionProgress++;
            if(creature.evolutionProgress >= 100) {
                creature.evolutionStage++;
                const stage = EVOLUTION_STAGES[creature.evolutionStage];
                creature.size = stage.size;
                creature.speed = stage.speed;
                creature.vision = stage.vision;
                creature.evolutionProgress = 0;
                createParticles(creature.x, creature.y, 50, '#ffffff');
            }
        }

        // ... (остальная логика движения и атак) ...
    });
}

function drawCreature(ctx, creature, x, y) {
    // Анимация движения
    const wave = Math.sin(creature.animationPhase) * 0.2;
    
    ctx.save();
    ctx.shadowBlur = 10 + creature.glow * 5;
    ctx.shadowColor = creature.color;
    
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(creature.direction);
    
    // Изменение формы при движении
    const sizeMod = Math.min(1 + creature.consumedFood * 0.1, 2);
    ctx.beginPath();
    ctx.ellipse(0, 0, 
        creature.size * sizeMod * (1 + wave), 
        creature.size * 0.8 * sizeMod * (1 - wave), 
        0, 0, Math.PI*2);
    ctx.fillStyle = creature.color;
    ctx.fill();
    
    // Полосы
    ctx.strokeStyle = '#ffffff22';
    ctx.lineWidth = 2;
    for(let i = -1; i <= 1; i += 0.5) {
        ctx.beginPath();
        ctx.ellipse(0, 0, 
            creature.size * 0.9 * sizeMod * (1 + wave), 
            creature.size * 0.7 * sizeMod * (1 - wave), 
            i, 0, Math.PI);
        ctx.stroke();
    }
    
    // Глаза
    const eyeDist = creature.size * 0.6 * sizeMod;
    [Math.PI/6, -Math.PI/6].forEach(offset => {
        ctx.beginPath();
        ctx.arc(eyeDist, 0, creature.size*0.2, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.beginPath();
        ctx.arc(eyeDist + 2, -2, creature.size*0.1, 0, Math.PI*2);
        ctx.fillStyle = '#000000';
        ctx.fill();
    });
    
    ctx.restore();
    ctx.restore();

    // Отображение уровня эволюции
    if(creature.evolutionStage > 0) {
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px Arial';
        ctx.fillText(`Lv. ${creature.evolutionStage + 1}`, x + creature.size, y);
    }
}

// ... (остальной код) ...

function draw() {
    ctx.fillStyle = '#0d1b2a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Отрисовка границ
    ctx.strokeStyle = '#ffffff44';
    ctx.lineWidth = 5;
    ctx.strokeRect(
        BORDER_SIZE - cameraX,
        BORDER_SIZE - cameraY,
        WORLD_SIZE - BORDER_SIZE*2,
        WORLD_SIZE - BORDER_SIZE*2
    );

    // ... (остальная отрисовка) ...
}

// ... (остальной код) ...
</script>
</body>
</html>