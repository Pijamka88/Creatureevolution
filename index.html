<!DOCTYPE html>
<html>
<head>
    <title>Microbe Evolution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            touch-action: none; 
            background: #0d1b2a; 
            -webkit-tap-highlight-color: transparent;
        }
        #gameCanvas { 
            position: absolute; 
            image-rendering: pixelated;
        }
        .ui {
            position: fixed; 
            padding: 15px; 
            background: #1b263bcc; 
            border-radius: 10px; 
            color: white; 
            font-family: 'Arial', sans-serif; 
            backdrop-filter: blur(5px);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            user-select: none;
        }
        #stats { top: 20px; left: 20px; }
        #abilities { bottom: 20px; right: 20px; text-align: right; }
        button {
            background: #415a77; 
            color: white; 
            border: none; 
            padding: 10px 15px;
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: 0.2s;
            font-size: 14px;
        }
        button:hover { background: #778da9; }
        #menu {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            text-align: center; 
            padding: 30px; 
            background: #1b263b; 
            border-radius: 15px;
        }
        #menu h1 { 
            margin: 0 0 20px; 
            color: #e0e1dd; 
            font-size: 2rem;
        }
        .hidden { display: none; }
        #joystick {
            position: fixed;
            left: 30px;
            bottom: 30px;
            width: 100px;
            height: 100px;
            background: #ffffff22;
            border-radius: 50%;
            display: none;
        }
        #joystickKnob {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #ffffff88;
            border-radius: 50%;
            left: 30px;
            top: 30px;
            transform: translate(-50%, -50%);
            touch-action: none;
        }
        @media (max-width: 600px) {
            #joystick { display: block; }
            #abilities button { padding: 8px 12px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Microbe Evolution</h1>
        <button onclick="startGame()">Start Game</button>
        <button onclick="showInstructions()">How to Play</button>
    </div>
    <canvas id="gameCanvas" class="hidden"></canvas>
    <div id="stats" class="ui hidden">
        <div>Health: <span id="health">100</span></div>
        <div>Energy: <span id="energy">50</span></div>
        <div>DNA: <span id="dna">0</span></div>
    </div>
    <div id="abilities" class="ui hidden">
        <button onclick="evolve('speed')">Speed+ (10 DNA)</button>
        <button onclick="evolve('health')">Health+ (15 DNA)</button>
        <button onclick="evolve('vision')">Vision+ (20 DNA)</button>
    </div>
    <div id="joystick">
        <div id="joystickKnob"></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const WORLD_SIZE = 3000;
let cameraX = 0, cameraY = 0;
let gameActive = false;
let joystickVector = { x: 0, y: 0 };

// Setup canvas
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const player = {
    x: WORLD_SIZE/2, y: WORLD_SIZE/2, size: 20,
    speed: 2, health: 100, energy: 50, dna: 0,
    vision: 200, direction: 0
};

const world = {
    resources: [],
    creatures: [],
    particles: [],
    herds: new Map()
};

// New creature designs
function drawCreature(ctx, creature, x, y) {
    // Body
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(creature.direction);
    
    // Main body
    ctx.beginPath();
    ctx.ellipse(0, 0, creature.size, creature.size*0.8, 0, 0, Math.PI*2);
    ctx.fillStyle = creature.color;
    ctx.fill();
    
    // Stripes
    ctx.strokeStyle = '#ffffff22';
    ctx.lineWidth = 2;
    for(let i = -1; i <= 1; i += 0.5) {
        ctx.beginPath();
        ctx.ellipse(0, 0, creature.size*0.9, creature.size*0.7, i, 0, Math.PI);
        ctx.stroke();
    }
    
    // Eyes
    const eyeDist = creature.size * 0.6;
    [Math.PI/6, -Math.PI/6].forEach(offset => {
        ctx.beginPath();
        ctx.arc(eyeDist, 0, creature.size*0.2, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.beginPath();
        ctx.arc(eyeDist + 2, -2, creature.size*0.1, 0, Math.PI*2);
        ctx.fillStyle = '#000000';
        ctx.fill();
    });
    
    ctx.restore();
}

// ... (остальной код остается таким же, за исключением отрисовки существ) ...

function draw() {
    ctx.fillStyle = '#0d1b2a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw resources
    world.resources.forEach(resource => {
        ctx.fillStyle = resource.type === 'food' ? '#00ff00' : '#00ffff';
        ctx.beginPath();
        ctx.arc(resource.x - cameraX, resource.y - cameraY, 5, 0, Math.PI*2);
        ctx.fill();
    });

    // Draw creatures
    world.creatures.concat([player]).forEach(creature => {
        const screenX = creature.x - cameraX;
        const screenY = creature.y - cameraY;
        drawCreature(ctx, creature, screenX, screenY);
    });

    // Draw particles
    world.particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life;
        ctx.beginPath();
        ctx.arc(p.x - cameraX, p.y - cameraY, 2, 0, Math.PI*2);
        ctx.fill();
    });
    ctx.globalAlpha = 1;
}

// Joystick controls
const joystick = document.getElementById('joystick');
const joystickKnob = document.getElementById('joystickKnob');
let joystickActive = false;

joystick.addEventListener('touchstart', (e) => {
    e.preventDefault();
    joystickActive = true;
    updateJoystick(e.touches[0]);
});

joystick.addEventListener('touchmove', (e) => {
    if(joystickActive) updateJoystick(e.touches[0]);
});

joystick.addEventListener('touchend', () => {
    joystickActive = false;
    joystickVector = { x: 0, y: 0 };
    joystickKnob.style.transform = 'translate(-50%, -50%)';
});

function updateJoystick(touch) {
    const rect = joystick.getBoundingClientRect();
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    
    const dx = touch.clientX - centerX;
    const dy = touch.clientY - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const maxDist = rect.width/2;
    
    if(dist > maxDist) {
        joystickVector = {
            x: dx/dist,
            y: dy/dist
        };
        joystickKnob.style.transform = `translate(${dx/maxDist*20 - 50}%, ${dy/maxDist*20 - 50}%)`;
    } else {
        joystickVector = {
            x: dx/maxDist,
            y: dy/maxDist
        };
        joystickKnob.style.transform = `translate(${dx/maxDist*50 - 50}%, ${dy/maxDist*50 - 50}%)`;
    }
}

// Update player movement
function update(deltaTime) {
    if (!gameActive) return;

    // Player movement
    const speed = player.speed * (player.energy > 0 ? 1 : 0.5);
    if(joystickVector.x !== 0 || joystickVector.y !== 0) {
        player.x += joystickVector.x * speed;
        player.y += joystickVector.y * speed;
        player.direction = Math.atan2(joystickVector.y, joystickVector.x);
        player.energy = Math.max(0, player.energy - 0.1);
    }
    
    // ... (остальная часть функции update остается такой же) ...
}

// ... (остальной код остается таким же) ...

// Инициализация
window.addEventListener('load', () => {
    resizeCanvas();
    document.getElementById('menu').classList.remove('hidden');
});

window.Telegram.WebApp.ready();
</script>
</body>
</html>