<!DOCTYPE html>
<html>
<head>
    <title>Microbe Evolution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; background: #1a1a1a; }
        #gameCanvas { position: absolute; }
        .ui {
            position: fixed; padding: 10px; background: #00000055; border-radius: 5px; 
            color: white; font-family: Arial; pointer-events: none;
        }
        #stats { top: 10px; left: 10px; }
        #abilities { bottom: 10px; right: 10px; text-align: right; }
        button { pointer-events: auto; background: #444; color: white; border: none; padding: 8px; margin: 2px; border-radius: 3px; }
        
        /* Меню */
        #menu {
            position: fixed;
            width: 100%;
            height: 100%;
            background: #000000dd;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .menu-item {
            margin: 10px;
            padding: 15px 30px;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        /* Джойстик */
        #joystick {
            position: fixed;
            bottom: 100px;
            left: 50px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ffffff33;
            display: none;
        }
        #joystickHandle {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #ffffff66;
            border-radius: 50%;
            left: 25px;
            top: 25px;
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Microbe Evolution</h1>
        <button class="menu-item" onclick="startGame()">Start Game</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="stats" class="ui">
        <div>Health: <span id="health">100</span></div>
        <div>Energy: <span id="energy">50</span></div>
        <div>DNA: <span id="dna">0</span></div>
    </div>
    <div id="joystick">
        <div id="joystickHandle"></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const WORLD_SIZE = 2000;
let cameraX = 0, cameraY = 0;
let gameActive = false;

// Настройки управления
const JOYSTICK_RADIUS = 50;
let joystickVector = { x: 0, y: 0 };

// Инициализация игры
function initGame() {
    gameActive = true;
    cameraX = 0;
    cameraY = 0;

    player.x = WORLD_SIZE/2;
    player.y = WORLD_SIZE/2;
    player.health = 100;
    player.energy = 50;
    player.dna = 0;

    world.resources = [];
    world.creatures = [];
    world.particles = [];

    generateWorld();
    update();
}

function startGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('joystick').style.display = 'block';
    initGame();
}

// Настройки существ
const FLOCK_SETTINGS = { /* ... (как в предыдущей версии) ... */ };

const REPRODUCTION_SETTINGS = { /* ... (как в предыдущей версии) ... */ };

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const player = {
    x: WORLD_SIZE/2, y: WORLD_SIZE/2, size: 20,
    speed: 2, health: 100, energy: 50, dna: 0,
    vision: 200, direction: 0
};

const world = {
    resources: [],
    creatures: [],
    particles: []
};

function createCreature(type, x, y, parent) {
    const base = parent ? { /* ... (как в предыдущей версии) ... */ } : {
        x, y, size: 15, health: 100,
        direction: 0, speed: 1.5,
        attack: 0, lastAttack: 0,
        attackCooldown: 0,
        lastReproduction: 0
    };
    
    if(!parent) {
        switch(type) {
            case 'predator':
                return {...base, 
                    color: '#ff4444', 
                    speed: 1.8, // Уменьшенная скорость
                    attack: 5,
                    vision: 300
                };
            // ... (остальные типы)
        }
    }
    return base;
}

function updateCreatures() {
    world.creatures.forEach(creature => {
        if(creature.attackCooldown > 0) creature.attackCooldown--;

        // Обновленное поведение хищников
        if(creature.attack) {
            const distToPlayer = distance(creature, player);
            if(distToPlayer < creature.vision) {
                if(distToPlayer > creature.size + player.size + 20 || creature.attackCooldown > 0) {
                    // Преследование
                    moveTowards(creature, player, creature.speed);
                } else {
                    // Атака и отступление
                    player.health -= creature.attack;
                    creature.attackCooldown = 100;
                    moveAwayFrom(creature, player, creature.speed * 2);
                    createParticles(player.x, player.y, 10, '#ff0000');
                }
            }
        }
        // ... (остальная логика)
    });
}

function moveTowards(obj, target, speed) {
    const dx = target.x - obj.x;
    const dy = target.y - obj.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist > 0) {
        obj.x += (dx/dist) * speed;
        obj.y += (dy/dist) * speed;
        obj.direction = Math.atan2(dy, dx);
    }
}

function moveAwayFrom(obj, target, speed) {
    const dx = obj.x - target.x;
    const dy = obj.y - target.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist > 0) {
        obj.x += (dx/dist) * speed;
        obj.y += (dy/dist) * speed;
        obj.direction = Math.atan2(dy, dx);
    }
}

function draw() {
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Рисование существ
    world.creatures.concat([player]).forEach(creature => {
        const screenX = creature.x - cameraX;
        const screenY = creature.y - cameraY;
        
        // Тело
        ctx.fillStyle = creature.color || '#ffffff';
        ctx.beginPath();
        ctx.arc(screenX, screenY, creature.size, 0, Math.PI*2);
        ctx.fill();

        // Белые глаза
        const eyeDist = creature.size * 0.4;
        const eyeAngle = creature.direction;
        [Math.PI/6, -Math.PI/6].forEach(offset => {
            ctx.fillStyle = '#ffffff'; // Белый цвет глаз
            ctx.beginPath();
            ctx.arc(
                screenX + Math.cos(eyeAngle + offset) * eyeDist,
                screenY + Math.sin(eyeAngle + offset) * eyeDist,
                creature.size * 0.2, 0, Math.PI*2
            );
            ctx.fill();
        });
    });
    // ... (остальная отрисовка)
}

// Джойстик
let joystickActive = false;
const joystickBase = document.getElementById('joystick');
const joystickHandle = document.getElementById('joystickHandle');

joystickBase.addEventListener('touchstart', handleJoystickStart);
document.addEventListener('touchmove', handleJoystickMove);
document.addEventListener('touchend', handleJoystickEnd);

function handleJoystickStart(e) {
    joystickActive = true;
    updateJoystickPosition(e.touches[0]);
}

function handleJoystickMove(e) {
    if(joystickActive) {
        e.preventDefault();
        updateJoystickPosition(e.touches[0]);
    }
}

function handleJoystickEnd() {
    joystickActive = false;
    joystickHandle.style.transform = 'translate(25px, 25px)';
    joystickVector = { x: 0, y: 0 };
}

function updateJoystickPosition(touch) {
    const rect = joystickBase.getBoundingClientRect();
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    
    let dx = touch.clientX - centerX;
    let dy = touch.clientY - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    
    if(dist > JOYSTICK_RADIUS) {
        dx = (dx/dist) * JOYSTICK_RADIUS;
        dy = (dy/dist) * JOYSTICK_RADIUS;
    }
    
    joystickHandle.style.transform = `translate(${dx + 25}px, ${dy + 25}px)`;
    joystickVector = { x: dx/JOYSTICK_RADIUS, y: dy/JOYSTICK_RADIUS };
}

// Игровой цикл
function update() {
    if(!gameActive) return;

    // Управление через джойстик
    if(joystickVector.x !== 0 || joystickVector.y !== 0) {
        player.x += joystickVector.x * player.speed;
        player.y += joystickVector.y * player.speed;
        player.direction = Math.atan2(joystickVector.y, joystickVector.x);
        player.energy = Math.max(0, player.energy - 0.1);
    }

    // Обновление камеры
    cameraX = player.x - canvas.width/2;
    cameraY = player.y - canvas.height/2;

    // Проверка здоровья
    if(player.health <= 0) {
        gameActive = false;
        document.getElementById('menu').style.display = 'flex';
        document.getElementById('joystick').style.display = 'none';
        return;
    }

    // ... (остальная логика обновления)
    
    requestAnimationFrame(update);
    draw();
}

// ... (остальные функции)

// Инициализация
window.Telegram.WebApp.ready();
</script>
</body>
</html>