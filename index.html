<!DOCTYPE html>
<html>
<head>
    <title>Microbe Evolution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Modern UI Design */
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #F44336;
            --background: #121212;
            --surface: #1E1E1E;
            --text: #FFFFFF;
            --text-secondary: #BDBDBD;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            touch-action: none; 
            background: var(--background); 
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        #gameCanvas { position: absolute; }

        .ui {
            position: fixed;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #stats { top: 16px; left: 16px; }
        #abilities { bottom: 16px; right: 16px; text-align: right; }

        button {
            background: var(--primary);
            color: var(--text);
            border: none;
            padding: 12px 16px;
            margin: 4px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }

        #menu {
            width: 320px;
            padding: 32px;
            text-align: center;
        }

        h1 {
            font-size: 32px;
            margin: 0 0 24px;
            color: var(--primary);
        }

        #gameOver {
            display: none;
            width: 280px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--primary);
            transition: width 0.2s;
        }

        .level-up {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            animation: pop 0.3s;
            display: none;
        }

        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.5); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <!-- Game UI -->
    <div id="stats" class="ui" style="display: none;">
        <div>Level: <span id="level">1</span></div>
        <div class="progress-bar"><div id="xpBar" class="progress"></div></div>
        <div>Health: <span id="health">100</span></div>
        <div>Energy: <span id="energy">50</span></div>
        <div>DNA: <span id="dna">0</span></div>
    </div>

    <div id="abilities" class="ui" style="display: none;">
        <button onclick="evolve('speed')">Speed+ (10 DNA)</button>
        <button onclick="evolve('health')">Health+ (15 DNA)</button>
        <button onclick="evolve('vision')">Vision+ (20 DNA)</button>
    </div>

    <!-- Level Up Modal -->
    <div id="levelUp" class="level-up ui">
        <h2>Level Up!</h2>
        <p>Choose your mutation:</p>
        <div id="mutationOptions"></div>
    </div>

    <!-- Menu -->
    <div id="menu" class="ui">
        <h1>Microbe Evolution</h1>
        <button onclick="startNewGame()">New Game</button>
        <button onclick="continueGame()" id="continueBtn">Continue</button>
    </div>

    <!-- Game Over -->
    <div id="gameOver" class="ui">
        <h2>Game Over!</h2>
        <p>You reached level <span id="finalLevel">1</span></p>
        <button onclick="showMenu()">Back to Menu</button>
    </div>

<script>
// Game Configuration
const config = {
    WORLD_SIZE: 3000,
    XP_PER_LEVEL: 100,
    MUTATION_CHANCE: 0.3,
    PREDATOR_COOLDOWN: 3000
};

// Game State
let gameState = 'menu';
let animationFrameId;
let cameraX = 0, cameraY = 0;
let targetX = null, targetY = null;

const player = {
    x: config.WORLD_SIZE/2, y: config.WORLD_SIZE/2,
    size: 20, speed: 2, health: 100, energy: 50,
    dna: 0, xp: 0, level: 1, vision: 200,
    direction: 0, mutations: []
};

const world = {
    resources: [],
    creatures: [],
    particles: []
};

// Modern Graphics Functions
function drawGlow(x, y, radius, color) {
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.shadowColor = color;
    ctx.shadowBlur = 20;
    ctx.fillStyle = color;
    ctx.fill();
    ctx.restore();
}

function drawEyes(x, y, direction, size) {
    const eyeDist = size * 0.4;
    const eyeSize = size * 0.15;
    const angle = direction;
    
    // Eye glow
    drawGlow(
        x + Math.cos(angle + Math.PI/6) * eyeDist,
        y + Math.sin(angle + Math.PI/6) * eyeDist,
        eyeSize * 2, 'rgba(255,255,255,0.3)'
    );
    
    // Eyes
    ctx.fillStyle = '#FFFFFF';
    [Math.PI/6, -Math.PI/6].forEach(offset => {
        ctx.beginPath();
        ctx.arc(
            x + Math.cos(angle + offset) * eyeDist,
            y + Math.sin(angle + offset) * eyeDist,
            eyeSize, 0, Math.PI * 2
        );
        ctx.fill();
    });
}

// Initialization
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Touch Controls for Mobile
function setupTouchControls() {
    const touchArea = document.createElement('div');
    touchArea.style.position = 'fixed';
    touchArea.style.bottom = '0';
    touchArea.style.left = '0';
    touchArea.style.right = '0';
    touchArea.style.height = '150px';
    touchArea.style.zIndex = '100';
    touchArea.style.background = 'rgba(0,0,0,0.3)';
    touchArea.style.backdropFilter = 'blur(5px)';
    document.body.appendChild(touchArea);

    touchArea.addEventListener('touchstart', handleTouch);
    touchArea.addEventListener('touchmove', handleTouch);
    touchArea.addEventListener('touchend', () => {
        targetX = null;
        targetY = null;
    });

    function handleTouch(e) {
        const touch = e.touches[0];
        targetX = touch.clientX;
        targetY = touch.clientY;
        e.preventDefault();
    }
}

// Rest of the game code remains similar but with updated graphics and mutations
// [Previous game logic code goes here, updated with new features]

// Mutation System
const mutations = {
    speed: {
        name: 'Swift Genes',
        description: '+0.5 Speed',
        effect: p => p.speed += 0.5
    },
    health: {
        name: 'Robust Cells',
        description: '+20 Max Health',
        effect: p => p.health += 20
    },
    vision: {
        name: 'Enhanced Senses',
        description: '+50 Vision Range',
        effect: p => p.vision += 50
    },
    energy: {
        name: 'Efficient Metabolism',
        description: '+25 Max Energy',
        effect: p => p.energy += 25
    }
};

function showLevelUp() {
    const options = Object.entries(mutations)
        .filter(([key]) => !player.mutations.includes(key))
        .sort(() => Math.random() - 0.5)
        .slice(0, 3);

    const optionsHtml = options.map(([key, mut]) => `
        <button onclick="applyMutation('${key}')">
            <strong>${mut.name}</strong><br>
            <small>${mut.description}</small>
        </button>
    `).join('');

    document.getElementById('mutationOptions').innerHTML = optionsHtml;
    document.getElementById('levelUp').style.display = 'block';
}

function applyMutation(key) {
    mutations[key].effect(player);
    player.mutations.push(key);
    document.getElementById('levelUp').style.display = 'none';
    updateStats();
}

// Initialize
setupTouchControls();
showMenu();
window.Telegram.WebApp.ready();
</script>
</body>
</html>